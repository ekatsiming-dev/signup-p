<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時儀表板 | Dashboard V3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#a94438',
                        accent: '#3a4a61',
                        dark: '#0f0f0f',
                        card: '#1e1e1e',
                        success: '#10b981'
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f0f0f; color: #f4f1ea; }
        .glass-card {
            background: rgba(36, 36, 36, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
        }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen p-6 md:p-12">

    <!-- Header -->
    <div class="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-end gap-4">
        <div>
            <h1 class="text-3xl font-bold text-primary flex items-center gap-3">
                <i class="fas fa-chart-pie"></i> 活動戰情儀表板
            </h1>
            <p class="text-gray-400 text-sm mt-1">即時監控 V3.0 系統數據</p>
        </div>
        <div class="flex gap-3">
            <a href="admin.html" class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm transition-colors text-gray-300">
                <i class="fas fa-cog mr-2"></i>前往管理後台
            </a>
            <button onclick="fetchData()" class="px-4 py-2 bg-accent hover:bg-slate-600 rounded-lg text-sm text-white transition-colors flex items-center gap-2">
                <i class="fas fa-sync-alt" id="refreshIcon"></i> 更新數據
            </button>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- Card 1 -->
        <div class="glass-card p-6 border-l-4 border-primary relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-20 h-20 bg-primary/10 rounded-bl-full transition-transform group-hover:scale-110"></div>
            <p class="text-gray-400 text-xs uppercase tracking-wider">總報名人數</p>
            <h2 class="text-4xl font-bold text-white mt-2" id="totalCount">0</h2>
            <div class="mt-2 text-xs text-gray-500">Total Signups</div>
        </div>
        
        <!-- Card 2 -->
        <div class="glass-card p-6 border-l-4 border-success relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-20 h-20 bg-success/10 rounded-bl-full transition-transform group-hover:scale-110"></div>
            <p class="text-gray-400 text-xs uppercase tracking-wider">已報到人數</p>
            <h2 class="text-4xl font-bold text-success mt-2" id="checkinCount">0</h2>
            <div class="mt-2 text-xs text-gray-500" id="checkinRate">0% 報到率</div>
        </div>

        <!-- Card 3 -->
        <div class="glass-card p-6 border-l-4 border-orange-400 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-20 h-20 bg-orange-400/10 rounded-bl-full transition-transform group-hover:scale-110"></div>
            <p class="text-gray-400 text-xs uppercase tracking-wider">院外人士 (需收據)</p>
            <h2 class="text-4xl font-bold text-orange-400 mt-2" id="externalCount">0</h2>
            <div class="mt-2 text-xs text-gray-500">External Guests</div>
        </div>

        <!-- Card 4 -->
        <div class="glass-card p-6 border-l-4 border-green-400 relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-20 h-20 bg-green-400/10 rounded-bl-full transition-transform group-hover:scale-110"></div>
            <p class="text-gray-400 text-xs uppercase tracking-wider">素食需求</p>
            <h2 class="text-4xl font-bold text-green-400 mt-2" id="vegCount">0</h2>
            <div class="mt-2 text-xs text-gray-500">Vegetarian Meals</div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="glass-card p-6">
            <h3 class="text-lg font-bold mb-4 border-b border-white/10 pb-2">身分分佈 (Identity)</h3>
            <div class="h-64 flex justify-center">
                <canvas id="identityChart"></canvas>
            </div>
        </div>
        <div class="glass-card p-6">
            <h3 class="text-lg font-bold mb-4 border-b border-white/10 pb-2">飲食習慣 (Diet)</h3>
            <div class="h-64 flex justify-center">
                <canvas id="dietChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent List -->
    <div class="max-w-7xl mx-auto glass-card p-6">
        <h3 class="text-lg font-bold mb-4 border-b border-white/10 pb-2">最新報名動態</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-400">
                <thead class="bg-white/5 text-gray-200">
                    <tr>
                        <th class="px-6 py-3">狀態</th>
                        <th class="px-6 py-3">姓名</th>
                        <th class="px-6 py-3">單位</th>
                        <th class="px-6 py-3">身份</th>
                        <th class="px-6 py-3">飲食</th>
                    </tr>
                </thead>
                <tbody id="recentTable" class="divide-y divide-white/5">
                    <tr><td colspan="5" class="p-4 text-center">載入中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 設定區 (已填入您的 API)
        const API_URL = "https://script.google.com/macros/s/AKfycbwRaE7CAYEUVC43_8StimbuLAZtaHYDPndailVfSq6UwKde_kgQtwl5Bow-LvD7Pgi-5Q/exec";
        
        let identityChart = null;
        let dietChart = null;

        document.addEventListener('DOMContentLoaded', fetchData);

        function fetchData() {
            const btn = document.getElementById('refreshIcon');
            btn.classList.add('fa-spin');

            fetch(API_URL)
                .then(res => res.json())
                .then(response => {
                    if(response.result === 'success') {
                        updateDashboard(response.data);
                    }
                })
                .catch(err => console.error(err))
                .finally(() => {
                    btn.classList.remove('fa-spin');
                });
        }

        function updateDashboard(data) {
            // 1. 計算數據
            const total = data.length;
            const checkin = data.filter(r => r.checkin === 'TRUE').length;
            const external = data.filter(r => r.identity === '院外').length;
            const internal = total - external;
            const veg = data.filter(r => r.diet === '素食').length;
            const meat = total - veg;

            // 2. 更新數字卡片
            animateValue("totalCount", total);
            animateValue("checkinCount", checkin);
            animateValue("externalCount", external);
            animateValue("vegCount", veg);
            
            const rate = total > 0 ? Math.round((checkin / total) * 100) : 0;
            document.getElementById("checkinRate").innerText = `${rate}% 報到率`;

            // 3. 更新圖表
            updateCharts(internal, external, meat, veg);

            // 4. 更新列表 (取最新 5 筆)
            renderRecentTable(data.slice().reverse().slice(0, 5));
        }

        function updateCharts(internal, external, meat, veg) {
            // Identity Chart
            const ctx1 = document.getElementById('identityChart').getContext('2d');
            if(identityChart) identityChart.destroy();
            identityChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['院內同仁', '院外人士'],
                    datasets: [{
                        data: [internal, external],
                        backgroundColor: ['#a94438', '#3a4a61'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { color: '#ccc' } } }
                }
            });

            // Diet Chart
            const ctx2 = document.getElementById('dietChart').getContext('2d');
            if(dietChart) dietChart.destroy();
            dietChart = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: ['葷食', '素食'],
                    datasets: [{
                        data: [meat, veg],
                        backgroundColor: ['#525252', '#4ade80'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { color: '#ccc' } } }
                }
            });
        }

        function renderRecentTable(data) {
            const tbody = document.getElementById('recentTable');
            tbody.innerHTML = '';
            
            data.forEach((row, i) => {
                const tr = document.createElement('tr');
                tr.className = "animate-fade-in-up hover:bg-white/5";
                tr.style.animationDelay = `${i * 100}ms`;
                
                const statusBadge = row.checkin === 'TRUE' 
                    ? '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs">已報到</span>'
                    : '<span class="px-2 py-1 bg-gray-500/20 text-gray-500 rounded text-xs">未報到</span>';

                tr.innerHTML = `
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4 text-white font-bold">${row.name}</td>
                    <td class="px-6 py-4">${row.org}</td>
                    <td class="px-6 py-4 text-xs">${row.identity}</td>
                    <td class="px-6 py-4 text-xs">${row.diet}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function animateValue(id, end) {
            const obj = document.getElementById(id);
            if (!obj) return;
            const start = parseInt(obj.innerText) || 0;
            if (start === end) return;
            let current = start;
            const increment = end > start ? 1 : -1;
            const timer = setInterval(() => {
                current += increment;
                obj.innerText = current;
                if (current === end) clearInterval(timer);
            }, 50);
        }
    </script>
</body>
</html>
